{% extends 'base.html.twig' %}

{% block title %}Nouvelle Publication{% endblock %}

{% block stylesheets %}
<style>
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        margin-top: 10px;
    }
    .preview-container {
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        background: #f9f9f9;
    }
    .step {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    .step-title {
        font-weight: bold;
        margin-bottom: 15px;
    }
    .ai-badge {
        font-size: 0.8rem;
        vertical-align: middle;
    }
    #generate-caption:disabled {
        opacity: 0.7;
    }
    .platform-preview {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        position: relative;
    }
    .facebook-preview {
        background: #f0f2f5;
        border: 1px solid #dddfe2;
    }
    .instagram-preview {
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        color: white;
        border: 1px solid #ccc;
    }
    .platform-logo {
        font-size: 24px;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block body %}
<div class="container mt-4">
    <h1>Créer une nouvelle publication</h1>

    <div class="card shadow-sm">
        <div class="card-body">
            {{ form_start(form, {'attr': {'id': 'publication-form'}}) }}

                <!-- Étape 1: Sélection de l'événement -->
                <div class="step">
                    <div class="step-title">1. Sélectionner un événement</div>
                    {% if event %}
                        <div class="alert alert-info">
                            Événement sélectionné : <strong>{{ event.nom }}</strong>
                            ({{ event.dateDebut|date('d/m/Y H:i') }})
                        </div>
                    {% else %}
                        {{ form_row(form.event, {
                            'attr': {'class': 'form-select'},
                            'label': false
                        }) }}
                    {% endif %}
                </div>

                <!-- Étape 2: Sélection de la plateforme -->
                <div class="step">
                    <div class="step-title">2. Partage vers</div>
                   <div class="mb-3">
                       <label for="publication_plateforme" class="form-label">Sélectionnez une plateforme</label>
                       <select id="publication_plateforme" name="{{ form.plateforme.vars.full_name }}" class="form-select">
                           {% for choice in form.plateforme.vars.choices %}
                               <option value="{{ choice.value }}">{{ choice.label }}</option>
                           {% endfor %}
                       </select>

                       <div class="d-flex mt-2 gap-2">
                           <a href="{{ path('connect_facebook_start') }}" class="btn btn-outline-primary btn-sm">
                               Se connecter à Facebook
                           </a>
                           <a href="#" class="btn btn-outline-danger btn-sm disabled">
                               Se connecter à Instagram
                           </a>
                           <a href="#" class="btn btn-outline-info btn-sm disabled">
                               Se connecter à Twitter
                           </a>
                       </div>
                   </div>
                </div>

                <!-- Étape 3: Création du contenu -->
                <div class="step">
                    <div class="step-title">3. Créer votre post</div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form_label(form.contenu, 'Votre légende') }}
                                <div class="input-group mb-3">
                                    {{ form_widget(form.contenu, {
                                        'attr': {
                                            'id': 'publication_contenu',
                                            'rows': 5,
                                            'class': 'form-control'
                                        }
                                    }) }}
                                    <button type="button" id="generate-caption" class="btn btn-outline-secondary">
                                        <i class="fas fa-magic"></i> Générer avec IA
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3">
                                {{ form_label(form.imagePath, 'Image') }}
                                {{ form_widget(form.imagePath, {
                                    'attr': {
                                        'class': 'form-control',
                                        'data-image-upload': 'true'
                                    }
                                }) }}
                                <small class="text-muted">Formats: JPG/PNG (max 5MB)</small>
                                <div id="imagePreview" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- Aperçu du post -->
                        <div class="col-md-6">
                            <div class="preview-container platform-preview">
                                <h5>Aperçu du post</h5>
                                <p class="text-muted">Prévisualisation selon la plateforme sélectionnée</p>
                                <hr>
                                <div id="postPreview">
                                    {% if event %}
                                        <p class="fw-bold">{{ event.nom }}</p>
                                        <p>{{ event.dateDebut|date('d/m/Y H:i') }}</p>
                                    {% endif %}
                                    <div class="caption-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Étape 4: Planification -->
                <div class="step">
                    <div class="step-title">4. Planifier la publication</div>
                    {{ form_row(form.datePublication, {
                        'attr': {'class': 'form-control'},
                        'label': 'Date de publication'
                    }) }}
                </div>

                <!-- Boutons d'action -->
                <div class="d-flex justify-content-end mt-4 gap-3">
                    <a href="{{ path('app_publication_index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Annuler
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Enregistrer
                    </button>
                </div>

            {{ form_end(form) }}
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageUpload = document.querySelector('[data-image-upload]');
    const imagePreview = document.getElementById('imagePreview');
    const generateBtn = document.getElementById('generate-caption');
    const contenuInput = document.getElementById('{{ form.contenu.vars.id }}');
    const eventSelect = document.querySelector('select[name="{{ form.event.vars.full_name }}"]');
    const platformSelect = document.getElementById('{{ form.plateforme.vars.id }}');
    const postPreview = document.getElementById('postPreview');

    // Gestion de l'upload d'image
    if (imageUpload) {
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded image-preview">`;
                }
                reader.readAsDataURL(file);
            }
        });
    }

    // Génération IA
    if (generateBtn) {
        generateBtn.addEventListener('click', async function() {
            const eventId = eventSelect ? eventSelect.value : null;

            if (!eventId) {
                alert('Veuillez sélectionner un événement');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Génération...';

            try {
                const response = await fetch('{{ path("app_generate_caption") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        event_id: eventId,
                        platform: platformSelect.value
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur serveur');
                }

                contenuInput.value = data.caption;
                updatePreview(data.caption);
                addAIBadge();

            } catch (error) {
                console.error(error);
                alert(error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Générer avec IA';
            }
        });
    }

    // Mise à jour de l'aperçu
    function updatePreview(text) {
        const previewContent = postPreview.querySelector('.caption-content');
        if (previewContent) {
            previewContent.textContent = text;
        }
    }

    function addAIBadge() {
        if (!document.querySelector('.ai-badge')) {
            const badge = document.createElement('span');
            badge.className = 'ai-badge badge bg-info ms-2';
            badge.innerHTML = '<i class="fas fa-robot"></i> IA';
            generateBtn.parentNode.insertBefore(badge, generateBtn.nextSibling);
        }
    }

    // Mise à jour en temps réel
    if (contenuInput) {
        contenuInput.addEventListener('input', function() {
            updatePreview(this.value);
        });
    }

    // Style selon la plateforme
    if (platformSelect) {
        platformSelect.addEventListener('change', function() {
            postPreview.parentElement.className = `preview-container platform-preview ${this.value}-preview`;
        });
    }
});
</script>
{% endblock %}